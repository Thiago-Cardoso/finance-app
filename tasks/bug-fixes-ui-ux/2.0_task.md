---
status: pending
parallelizable: false
blocked_by: ["1.0"]
---

<task_context>
<domain>frontend/ui/data-display</domain>
<type>implementation</type>
<scope>bug_fix</scope>
<complexity>medium</complexity>
<dependencies>api|state_management|formatting</dependencies>
<unblocks>"3.0"</unblocks>
</task_context>

# Tarefa 2.0: Correção de Valores na Listagem de Transações

## Visão Geral

Corrigir os problemas identificados na tarefa 1.0 relacionados à exibição de valores na listagem de transações. Esta tarefa implementará as soluções propostas no diagnóstico para garantir que todos os valores monetários sejam exibidos corretamente.

## Requisitos

1. Garantir que raw_amount seja retornado pela API
2. Corrigir função formatCurrency para lidar com todos os casos
3. Validar tipos TypeScript estão corretos
4. Assegurar que valores apareçam corretamente formatados
5. Implementar tratamento de erros para valores inválidos

## Subtarefas

- [ ] 2.1 Corrigir Backend (se necessário)
  - Verificar TransactionSerializer
  - Garantir que raw_amount seja incluído na resposta
  - Validar formato numérico do campo
  - Testar endpoint manualmente

- [ ] 2.2 Atualizar/Verificar formatCurrency
  - Arquivo: `/frontend/src/lib/utils.ts`
  - Implementar validação para valores undefined/null
  - Adicionar tratamento para valores não numéricos
  - Garantir formatação correta de decimais
  - Testar com valores edge case (0, negativo, muito grande)

- [ ] 2.3 Corrigir TransactionItem
  - Arquivo: `/frontend/src/components/transactions/TransactionItem.tsx`
  - Adicionar validação antes de chamar formatCurrency
  - Implementar fallback para valores inválidos
  - Adicionar console.error para debug se necessário

- [ ] 2.4 Validar Tipos TypeScript
  - Arquivo: `/frontend/src/types/transaction.ts`
  - Confirmar que raw_amount é obrigatório e number
  - Atualizar interfaces se necessário
  - Verificar consistência entre tipos e resposta da API

- [ ] 2.5 Atualizar Hook useTransactions
  - Arquivo: `/frontend/src/hooks/useTransactions.ts`
  - Verificar se dados são transformados corretamente
  - Adicionar validação de dados recebidos
  - Implementar tratamento de erros

- [ ] 2.6 Testar Correções
  - Criar transações de teste variadas
  - Validar formatação de valores
  - Testar cores corretas (verde/vermelho/azul)
  - Verificar sinais (+/-) aparecem

## Sequenciamento

- Bloqueado por: 1.0 (Diagnóstico)
- Desbloqueia: 3.0 (Data Padrão)
- Paralelizável: Não (sequencial na Lane de Transações)

## Detalhes de Implementação

### 1. Backend - TransactionSerializer

Se o problema for no backend, criar ou atualizar o serializer:

```ruby
# /backend/app/serializers/transaction_serializer.rb
class TransactionSerializer
  def initialize(transaction)
    @transaction = transaction
  end

  def as_json
    {
      id: @transaction.id,
      description: @transaction.description,
      amount: format_currency(@transaction.amount),
      raw_amount: @transaction.amount.to_f,  # Garantir que seja numérico
      transaction_type: @transaction.transaction_type,
      date: @transaction.date.to_s,
      notes: @transaction.notes,
      category: category_json,
      account: account_json,
      transfer_account: transfer_account_json,
      created_at: @transaction.created_at.iso8601,
      updated_at: @transaction.updated_at.iso8601
    }
  end

  private

  def format_currency(amount)
    ActionController::Base.helpers.number_to_currency(
      amount,
      unit: 'R$',
      separator: ',',
      delimiter: '.'
    )
  end

  def category_json
    return nil unless @transaction.category

    {
      id: @transaction.category.id,
      name: @transaction.category.name,
      color: @transaction.category.color,
      icon: @transaction.category.icon,
      category_type: @transaction.category.category_type
    }
  end

  def account_json
    return nil unless @transaction.account

    {
      id: @transaction.account.id,
      name: @transaction.account.name,
      account_type: @transaction.account.account_type,
      current_balance: @transaction.account.current_balance.to_f
    }
  end

  def transfer_account_json
    return nil unless @transaction.transfer_account

    {
      id: @transaction.transfer_account.id,
      name: @transaction.transfer_account.name,
      account_type: @transaction.transfer_account.account_type,
      current_balance: @transaction.transfer_account.current_balance.to_f
    }
  end
end
```

### 2. Frontend - formatCurrency Function

Implementação robusta da função de formatação:

```typescript
// /frontend/src/lib/utils.ts

export function formatCurrency(value: number | undefined | null): string {
  // Validação de entrada
  if (value === undefined || value === null || isNaN(value)) {
    console.warn('formatCurrency: Valor inválido recebido', value)
    return 'R$ 0,00'
  }

  // Converter para número se for string
  const numericValue = typeof value === 'string' ? parseFloat(value) : value

  // Validar após conversão
  if (isNaN(numericValue)) {
    console.warn('formatCurrency: Valor não numérico', value)
    return 'R$ 0,00'
  }

  // Formatar usando Intl.NumberFormat
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  }).format(numericValue)
}
```

### 3. TransactionItem - Validação e Exibição

Atualizar o componente para validar antes de exibir:

```typescript
// /frontend/src/components/transactions/TransactionItem.tsx

export function TransactionItem({ transaction, onEdit }: TransactionItemProps) {
  // ... código existente ...

  // Validar raw_amount
  const amount = transaction.raw_amount ?? 0
  const isValidAmount = typeof amount === 'number' && !isNaN(amount)

  if (!isValidAmount) {
    console.error('TransactionItem: Valor inválido para transação', {
      id: transaction.id,
      raw_amount: transaction.raw_amount,
      type: typeof transaction.raw_amount
    })
  }

  return (
    <div className="px-6 py-4 hover:bg-gray-50 transition-colors">
      <div className="flex items-center justify-between">
        {/* ... código existente ... */}

        <div className="flex items-center space-x-4 flex-shrink-0">
          <div className="text-right">
            <div
              className={cn(
                'text-lg font-semibold',
                isIncome && 'text-green-600',
                isExpense && 'text-red-600',
                transaction.transaction_type === 'transfer' && 'text-blue-600'
              )}
            >
              {isIncome && '+'}
              {isExpense && '-'}
              {formatCurrency(Math.abs(amount))}
            </div>
            {/* ... resto do código ... */}
          </div>
        </div>
      </div>
    </div>
  )
}
```

### 4. Tipos TypeScript

Garantir tipos corretos:

```typescript
// /frontend/src/types/transaction.ts

export interface Transaction {
  id: number
  description: string
  amount: string  // Formatado (ex: "R$ 1.000,00")
  raw_amount: number  // Valor numérico puro
  transaction_type: 'income' | 'expense' | 'transfer'
  date: string
  notes?: string
  category?: {
    id: number
    name: string
    color: string
    icon?: string
    category_type: 'income' | 'expense' | 'both'
  }
  account?: {
    id: number
    name: string
    account_type: string
    current_balance: number
  }
  transfer_account?: {
    id: number
    name: string
    account_type: string
    current_balance: number
  }
  created_at: string
  updated_at: string
}
```

## Cenários de Teste

### Teste 1: Valores Positivos
- Criar receita de R$ 1.500,00
- Verificar: "+R$ 1.500,00" em verde
- Verificar formato com ponto para milhar e vírgula para decimal

### Teste 2: Valores Negativos
- Criar despesa de R$ 250,50
- Verificar: "-R$ 250,50" em vermelho
- Confirmar duas casas decimais

### Teste 3: Valores Decimais
- Criar transação de R$ 99,99
- Verificar formatação correta
- Testar também R$ 10,05 (zero no meio)

### Teste 4: Valores Grandes
- Criar transação de R$ 1.000.000,00
- Verificar separadores de milhar
- Confirmar legibilidade

### Teste 5: Valores Zero
- Criar transação de R$ 0,00
- Verificar que não quebra a interface
- Validar formatação

### Teste 6: Valores com Muitos Decimais
- API pode retornar 100.5555
- Deve formatar para R$ 100,56 (arredondado)

## Critérios de Sucesso

- [ ] Todos os valores aparecem formatados corretamente
- [ ] Cores corretas: verde (receita), vermelho (despesa), azul (transferência)
- [ ] Sinais +/- aparecem conforme esperado
- [ ] Sem erros no console do navegador
- [ ] Formatação consistente (R$ X.XXX,XX)
- [ ] Valores edge case (0, null, undefined) tratados
- [ ] Testes manuais passando para todos os cenários
- [ ] Código TypeScript sem erros de tipo

## Arquivos a Modificar

### Backend (se necessário)
- `/backend/app/serializers/transaction_serializer.rb` (criar se não existir)
- `/backend/app/controllers/api/v1/transactions_controller.rb` (usar serializer)

### Frontend
- `/frontend/src/lib/utils.ts` (formatCurrency)
- `/frontend/src/components/transactions/TransactionItem.tsx` (validação)
- `/frontend/src/types/transaction.ts` (tipos, se necessário)
- `/frontend/src/hooks/useTransactions.ts` (validação, se necessário)

## Validação Final

### Checklist de Teste
- [ ] Criar 3 receitas com valores diferentes
- [ ] Criar 3 despesas com valores diferentes
- [ ] Criar 2 transferências
- [ ] Verificar lista completa de transações
- [ ] Recarregar página e verificar persistência
- [ ] Testar em modo escuro e claro
- [ ] Testar em mobile (responsivo)
- [ ] Verificar console sem erros

### Regressão
- [ ] Criação de transação ainda funciona
- [ ] Edição de transação ainda funciona
- [ ] Exclusão de transação ainda funciona
- [ ] Filtros ainda funcionam
- [ ] Paginação ainda funciona

## Tempo Estimado

1-2 horas

## Próximos Passos

Após completar esta tarefa:
- Seguir para Tarefa 3.0 (Data Padrão em Transações)
- Se bugs adicionais forem descobertos, documentar para correção futura
