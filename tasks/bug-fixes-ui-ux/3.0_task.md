---
status: pending
parallelizable: false
blocked_by: ["2.0"]
---

<task_context>
<domain>frontend/ui/forms</domain>
<type>implementation</type>
<scope>user_experience</scope>
<complexity>low</complexity>
<dependencies>forms|datetime</dependencies>
<unblocks>none</unblocks>
</task_context>

# Tarefa 3.0: Implementar Data Padrão em Transações

## Visão Geral

Implementar funcionalidade para que o campo de data no formulário de criação de transações seja automaticamente preenchido com a data atual. Isso melhora a experiência do usuário, pois a maioria das transações são registradas na data em que ocorrem.

## Requisitos

1. Campo de data deve vir preenchido com a data atual ao abrir o formulário
2. Usuário deve poder alterar a data se necessário
3. Formato da data deve ser compatível com input type="date"
4. Funcionalidade deve funcionar tanto para receitas quanto para despesas
5. Data deve ser local (timezone do usuário)

## Subtarefas

- [ ] 3.1 Analisar TransactionForm atual
  - Arquivo: `/frontend/src/components/transactions/TransactionForm.tsx`
  - Verificar implementação atual do defaultValues
  - Confirmar que data atual já está implementada (linha 57)

- [ ] 3.2 Verificar se implementação funciona
  - Testar abertura do modal de nova transação
  - Verificar se data vem preenchida
  - Se já funciona, documentar e concluir
  - Se não funciona, identificar o problema

- [ ] 3.3 Corrigir implementação (se necessário)
  - Garantir formato correto: YYYY-MM-DD
  - Implementar função helper se necessário
  - Testar com diferentes timezones

- [ ] 3.4 Validar comportamento no modo edição
  - Ao editar transação, deve mostrar data da transação
  - Não deve sempre resetar para data atual
  - Manter lógica condicional correta

- [ ] 3.5 Testar em diferentes cenários
  - Criar nova receita
  - Criar nova despesa
  - Criar nova transferência
  - Editar transação existente
  - Cancelar e reabrir formulário

## Sequenciamento

- Bloqueado por: 2.0 (Correção de Valores)
- Desbloqueia: Nenhuma (última tarefa da Lane de Transações)
- Paralelizável: Não (sequencial na Lane de Transações)

## Detalhes de Implementação

### Análise do Código Atual

O código atual em `/frontend/src/components/transactions/TransactionForm.tsx` já implementa data padrão:

```typescript
// Linha 45-60
defaultValues: transaction ? {
  description: transaction.description || '',
  amount: transaction.raw_amount?.toString() || '',
  transaction_type: transaction.transaction_type || 'expense',
  date: transaction.date || new Date().toISOString().split('T')[0],
  category_id: transaction.category?.id?.toString() || '',
  account_id: transaction.account?.id?.toString() || '',
  transfer_account_id: transaction.transfer_account?.id?.toString() || '',
  notes: transaction.notes || '',
} : {
  transaction_type: initialType || 'expense',
  date: new Date().toISOString().split('T')[0],  // ← DATA ATUAL AQUI
  description: '',
  amount: '',
}
```

### Verificação Necessária

1. **Confirmar que funciona na prática**
   - Abrir modal de nova transação
   - Verificar se campo date está preenchido
   - Confirmar formato visual do campo

2. **Se não funciona, possíveis causas:**
   - React Hook Form não está aplicando defaultValues
   - Formato da data está incorreto
   - Reset do formulário não está funcionando
   - Cache do navegador

### Solução Alternativa (se necessário)

Se a implementação atual não funciona, usar useEffect:

```typescript
// Adicionar ao TransactionForm
import { useEffect } from 'react'

export function TransactionForm({ transaction, initialType, onSuccess, onCancel }: TransactionFormProps) {
  const isEditing = !!transaction

  // ... código existente ...

  const { register, handleSubmit, watch, setValue, reset, formState } = useForm<TransactionFormData>({
    resolver: zodResolver(transactionFormSchema),
    defaultValues: {
      transaction_type: 'expense',
      date: getCurrentDate(),
      description: '',
      amount: '',
    }
  })

  // Garantir data atual em novas transações
  useEffect(() => {
    if (!isEditing && !transaction) {
      setValue('date', getCurrentDate())
    }
  }, [isEditing, transaction, setValue])

  // Ao carregar transação existente
  useEffect(() => {
    if (transaction) {
      reset({
        description: transaction.description || '',
        amount: transaction.raw_amount?.toString() || '',
        transaction_type: transaction.transaction_type || 'expense',
        date: transaction.date || getCurrentDate(),
        category_id: transaction.category?.id?.toString() || '',
        account_id: transaction.account?.id?.toString() || '',
        transfer_account_id: transaction.transfer_account?.id?.toString() || '',
        notes: transaction.notes || '',
      })
    }
  }, [transaction, reset])

  // ... resto do código ...
}

// Função helper
function getCurrentDate(): string {
  const now = new Date()
  const year = now.getFullYear()
  const month = String(now.getMonth() + 1).padStart(2, '0')
  const day = String(now.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}
```

### Criar Função Utilitária (Recomendado)

Criar helper reutilizável em `/frontend/src/lib/utils.ts`:

```typescript
/**
 * Retorna a data atual no formato YYYY-MM-DD
 * Compatível com input type="date"
 */
export function getCurrentDateString(): string {
  const now = new Date()
  const year = now.getFullYear()
  const month = String(now.getMonth() + 1).padStart(2, '0')
  const day = String(now.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}

/**
 * Formata uma data Date para YYYY-MM-DD
 */
export function formatDateForInput(date: Date): string {
  const year = date.getFullYear()
  const month = String(date.getMonth() + 1).padStart(2, '0')
  const day = String(date.getDate()).padStart(2, '0')
  return `${year}-${month}-${day}`
}

/**
 * Parse string YYYY-MM-DD para Date
 */
export function parseDateFromInput(dateString: string): Date {
  return new Date(dateString + 'T00:00:00')
}
```

Então usar no formulário:

```typescript
import { getCurrentDateString } from '@/lib/utils'

// No defaultValues
defaultValues: {
  transaction_type: initialType || 'expense',
  date: getCurrentDateString(),
  description: '',
  amount: '',
}
```

## Cenários de Teste

### Teste 1: Nova Transação - Receita
1. Clicar em "Nova Transação"
2. Selecionar tipo "Receita"
3. Verificar campo Data
4. Confirmar que está preenchido com data atual
5. Confirmar formato: DD/MM/YYYY no visual (YYYY-MM-DD no value)

### Teste 2: Nova Transação - Despesa
1. Clicar em "Nova Transação"
2. Tipo padrão é "Despesa"
3. Verificar campo Data preenchido
4. Confirmar data atual

### Teste 3: Nova Transação - Transferência
1. Clicar em "Nova Transação"
2. Selecionar tipo "Transferência"
3. Verificar campo Data preenchido
4. Confirmar data atual

### Teste 4: Editar Transação Existente
1. Criar transação com data 01/01/2025
2. Clicar em editar
3. Verificar que data mostrada é 01/01/2025
4. NÃO deve ser data atual
5. Confirmar que pode alterar

### Teste 5: Alterar Data Manualmente
1. Criar nova transação
2. Alterar data para ontem
3. Salvar
4. Confirmar que salvou com data alterada

### Teste 6: Validação de Data
1. Tentar limpar campo data
2. Tentar submeter formulário
3. Deve mostrar erro de validação
4. Campo data é obrigatório

### Teste 7: Cancelar e Reabrir
1. Abrir modal de nova transação
2. Alterar data para 01/01/2025
3. Cancelar sem salvar
4. Reabrir modal
5. Data deve voltar para atual (não manter alteração anterior)

### Teste 8: Timezone
1. Verificar que data é do timezone local do usuário
2. Não deve usar UTC se resultar em data diferente
3. Exemplo: às 23:00 de 15/01, deve ser 15/01, não 16/01

## Critérios de Sucesso

- [ ] Campo data vem preenchido com data atual ao criar transação
- [ ] Formato da data é correto (compatível com input type="date")
- [ ] Usuário pode alterar a data livremente
- [ ] Ao editar transação, data mostrada é a da transação, não atual
- [ ] Ao cancelar e reabrir, data volta para atual
- [ ] Funciona para todos os tipos de transação (receita, despesa, transferência)
- [ ] Data respeita timezone local do usuário
- [ ] Sem erros no console
- [ ] Validação de campo obrigatório funciona

## Arquivos a Modificar

### Principal
- `/frontend/src/components/transactions/TransactionForm.tsx`

### Opcional (se criar helpers)
- `/frontend/src/lib/utils.ts`

### Validação (não modificar, apenas verificar)
- `/frontend/src/lib/validations.ts` (schema do formulário)

## Impacto em Outros Componentes

Esta mudança não deve afetar outros componentes, mas verificar:
- [ ] TransactionList - não afetado
- [ ] TransactionItem - não afetado
- [ ] TransactionFilters - não afetado
- [ ] Dashboard - não afetado

## Considerações de UX

1. **Feedback Visual**
   - Input type="date" já fornece calendario visual
   - Usuário vê data preenchida imediatamente
   - Fácil de alterar se necessário

2. **Acessibilidade**
   - Label clara: "Data"
   - Campo marcado como required
   - Erro de validação visível

3. **Mobile**
   - Input type="date" abre teclado/picker nativo
   - Formato correto para dispositivo
   - Fácil de usar em touch

## Tratamento de Erros

```typescript
// Adicionar validação extra se necessário
const handleDateChange = (value: string) => {
  try {
    const date = new Date(value)
    if (isNaN(date.getTime())) {
      console.error('Data inválida:', value)
      setValue('date', getCurrentDateString())
      return
    }
    setValue('date', value)
  } catch (error) {
    console.error('Erro ao processar data:', error)
    setValue('date', getCurrentDateString())
  }
}
```

## Validação Final

### Checklist Funcional
- [ ] Nova receita - data atual ✓
- [ ] Nova despesa - data atual ✓
- [ ] Nova transferência - data atual ✓
- [ ] Editar transação - data da transação ✓
- [ ] Alterar data manualmente - funciona ✓
- [ ] Campo obrigatório - validação ✓
- [ ] Cancelar/reabrir - reset correto ✓

### Checklist Técnico
- [ ] Código TypeScript sem erros
- [ ] Sem warnings no console
- [ ] Formato de data correto
- [ ] React Hook Form funcionando
- [ ] Validação com Zod funcionando

### Checklist de UX
- [ ] Comportamento intuitivo
- [ ] Feedback visual claro
- [ ] Fácil de alterar data
- [ ] Mobile friendly
- [ ] Acessível

## Documentação

Se mudanças significativas forem feitas, documentar:
- Função helper criada (se aplicável)
- Motivo da mudança
- Comportamento esperado

## Tempo Estimado

30-60 minutos

## Notas Adicionais

- Esta é uma melhoria de UX simples mas importante
- A maioria dos sistemas financeiros usa data atual como padrão
- Reduz fricção no registro de transações diárias
- Mantém flexibilidade para registrar transações retroativas
