# 3.0 - Sistema de Autentica√ß√£o

**Sprint:** Sprint 1 (Semanas 2-3)
**Prioridade:** P0
**Estimativa:** 4 dias
**Paraleliz√°vel:** N√£o

---

## üìã Descri√ß√£o

Implementa sistema completo de autentica√ß√£o com cadastro, login, recupera√ß√£o de senha e biometria (Touch ID/Face ID). Integra-se com a API Rails existente usando JWT e implementa o padr√£o MVVM com ViewModel separado da View.

A autentica√ß√£o √© cr√≠tica para todo o app, protegendo dados financeiros sens√≠veis. Inclui armazenamento seguro de tokens (SecureStore), valida√ß√£o de formul√°rios com Zod, e fallback para senha quando biometria n√£o est√° dispon√≠vel.

---

## üéØ Objetivos

- [ ] Implementar telas de cadastro e login
- [ ] Integrar com API Rails (JWT)
- [ ] Adicionar autentica√ß√£o biom√©trica
- [ ] Criar ViewModel de autentica√ß√£o
- [ ] Implementar recupera√ß√£o de senha
- [ ] Validar formul√°rios com Zod

---

## üìù Subtarefas

### 3.1 - Service de Autentica√ß√£o (API)
**Estimativa:** M
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/shared/services/api/client.ts`
- `src/shared/services/api/auth.service.ts`

**Comandos:**
```bash
npm install axios expo-secure-store
```

**C√≥digo:**
```typescript
// auth.service.ts
import { apiClient } from './client';

interface SignUpData {
  email: string;
  password: string;
  first_name: string;
  last_name: string;
}

export async function signUp(data: SignUpData) {
  const response = await apiClient.post('/api/v1/auth/sign_up', {
    user: data
  });
  return response.data;
}

export async function signIn(email: string, password: string) {
  const response = await apiClient.post('/api/v1/auth/sign_in', {
    user: { email, password }
  });
  return response.data;
}
```

**Checklist:**
- [ ] Axios client configurado
- [ ] Interceptors para JWT
- [ ] SignUp service implementado
- [ ] SignIn service implementado
- [ ] Reset password service
- [ ] Refresh token service

### 3.2 - Schemas de Valida√ß√£o (Zod)
**Estimativa:** S
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/shared/schemas/auth.schema.ts`

**C√≥digo:**
```typescript
import { z } from 'zod';

export const signUpSchema = z.object({
  email: z.string().email('Email inv√°lido'),
  password: z.string().min(8, 'Senha deve ter no m√≠nimo 8 caracteres'),
  first_name: z.string().min(2, 'Nome muito curto'),
  last_name: z.string().min(2, 'Sobrenome muito curto'),
});

export const signInSchema = z.object({
  email: z.string().email('Email inv√°lido'),
  password: z.string().min(1, 'Senha obrigat√≥ria'),
});
```

**Checklist:**
- [ ] Schema de cadastro criado
- [ ] Schema de login criado
- [ ] Schema de reset password
- [ ] Mensagens de erro em portugu√™s

### 3.3 - Zustand Auth Store
**Estimativa:** M
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/shared/stores/authStore.ts`

**Checklist:**
- [ ] Store com user, token, isAuthenticated
- [ ] A√ß√µes de login/logout
- [ ] Persist√™ncia de user (AsyncStorage)
- [ ] Tokens em SecureStore (criptografado)
- [ ] Refresh token autom√°tico

### 3.4 - ViewModel de Autentica√ß√£o
**Estimativa:** M
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/viewModels/useAuth.viewModel.ts`

**C√≥digo:**
```typescript
import { useState } from 'react';
import { useAuthStore } from '@/shared/stores/authStore';
import { signIn, signUp } from '@/shared/services/api/auth.service';
import { signInSchema } from '@/shared/schemas/auth.schema';

export function useAuthViewModel() {
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const { setUser, setTokens } = useAuthStore();

  async function handleSignIn(email: string, password: string) {
    try {
      setIsLoading(true);
      setError(null);

      // Validar com Zod
      signInSchema.parse({ email, password });

      // Chamar API
      const response = await signIn(email, password);

      // Salvar tokens e user
      await setTokens(response.data.token, response.data.refresh_token);
      setUser(response.data.user);

      return { success: true };
    } catch (err: any) {
      setError(err.message);
      return { success: false, error: err.message };
    } finally {
      setIsLoading(false);
    }
  }

  return {
    handleSignIn,
    isLoading,
    error,
  };
}
```

**Checklist:**
- [ ] useAuth.viewModel implementado
- [ ] Valida√ß√£o com Zod integrada
- [ ] Loading e error states
- [ ] Tratamento de erros da API

### 3.5 - Tela de Login
**Estimativa:** L
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/app/auth/Login.view.tsx`
- `src/app/auth/components/BiometricPrompt.tsx`

**Checklist:**
- [ ] Formul√°rio de login com React Hook Form
- [ ] Valida√ß√£o inline
- [ ] Bot√£o de biometria
- [ ] Link para recupera√ß√£o de senha
- [ ] Link para cadastro
- [ ] Loading state

### 3.6 - Tela de Cadastro
**Estimativa:** L
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/app/auth/Register.view.tsx`

**Checklist:**
- [ ] Formul√°rio de cadastro completo
- [ ] Valida√ß√£o com Zod
- [ ] Confirma√ß√£o de senha
- [ ] Termos de uso checkbox
- [ ] Loading state

### 3.7 - Recupera√ß√£o de Senha
**Estimativa:** M
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/app/auth/ForgotPassword.view.tsx`

**Checklist:**
- [ ] Tela de solicita√ß√£o de reset
- [ ] Integra√ß√£o com endpoint da API
- [ ] Feedback de email enviado

### 3.8 - Autentica√ß√£o Biom√©trica
**Estimativa:** L
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/shared/hooks/useBiometric.ts`

**Comandos:**
```bash
npm install expo-local-authentication
```

**C√≥digo:**
```typescript
import * as LocalAuthentication from 'expo-local-authentication';

export async function authenticateWithBiometrics() {
  const hasHardware = await LocalAuthentication.hasHardwareAsync();
  if (!hasHardware) return { success: false, error: 'No biometric hardware' };

  const isEnrolled = await LocalAuthentication.isEnrolledAsync();
  if (!isEnrolled) return { success: false, error: 'No biometrics enrolled' };

  const result = await LocalAuthentication.authenticateAsync({
    promptMessage: 'Autentique-se para acessar',
    fallbackLabel: 'Usar senha',
  });

  return { success: result.success };
}
```

**Checklist:**
- [ ] Hook useBiometric criado
- [ ] Verifica√ß√£o de hardware
- [ ] Prompt de biometria
- [ ] Fallback para senha
- [ ] Prefer√™ncia persistida

### 3.9 - Testes Unit√°rios
**Estimativa:** M
**Tipo:** Teste

**Arquivos:**
- `__tests__/unit/viewModels/useAuth.viewModel.test.ts`
- `__tests__/unit/services/auth.service.test.ts`

**Checklist:**
- [ ] Testes do ViewModel
- [ ] Testes do service
- [ ] Mocks da API
- [ ] Cobertura > 80%

---

## üîó Depend√™ncias

**Bloqueia:** 4.0, 5.0, 7.0, 15.0
**Bloqueado por:** 2.0
**Paralelo com:** Nenhuma

---

## ‚úÖ Crit√©rios de Sucesso

- [ ] Cadastro funcionando end-to-end
- [ ] Login com email/senha funcional
- [ ] Biometria funcionando em iOS e Android
- [ ] Tokens salvos em SecureStore
- [ ] Recupera√ß√£o de senha funcional
- [ ] Valida√ß√£o de formul√°rios robusta
- [ ] Cobertura de testes: 80%
- [ ] Code review aprovado

---

## üìö Refer√™ncias

- [PRD - RF01](../prd.md#rf01---autentica√ß√£o-e-onboarding)
- [Tech Spec - 3.2.1](../tech-spec.md#321-autentica√ß√£o)
- [Expo Local Auth](https://docs.expo.dev/versions/latest/sdk/local-authentication/)

---

## üè∑Ô∏è Tags

`#authentication` `#security` `#jwt` `#biometrics` `#critical`

---

## üìå Notas Importantes

- Tokens JWT em SecureStore (criptografado), NUNCA em AsyncStorage
- Implementar refresh token autom√°tico antes de expirar
- Biometria √© opcional, sempre permitir fallback para senha
- Timeout de sess√£o: 30 minutos de inatividade
- Validar email e senha no backend tamb√©m
- Implementar rate limiting (API respons√°vel)
- Testar em dispositivos reais para biometria

---

**Criado em:** 2025-11-10
**Atualizado em:** 2025-11-17
**Status:** ‚úÖ Conclu√≠da
