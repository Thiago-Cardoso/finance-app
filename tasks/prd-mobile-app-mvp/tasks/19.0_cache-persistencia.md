# 19.0 - Sistema de Cache e PersistÃªncia

**Sprint:** Sprint 3 (Semana 9)
**Prioridade:** P1
**Estimativa:** 3 dias
**ParalelizÃ¡vel:** Sim

---

## ğŸ“‹ DescriÃ§Ã£o

Implementa sistema robusto de cache e persistÃªncia de dados usando AsyncStorage para preferÃªncias e cache in-memory via Zustand para dados da API. NÃƒO usa SQLite para dados de negÃ³cio (API Rails Ã© fonte Ãºnica de verdade).

Cache melhora performance e experiÃªncia offline bÃ¡sica (leitura apenas). TTL de 5 minutos para dados transacionais, indefinido para preferÃªncias.

---

## ğŸ¯ Objetivos

- [ ] Implementar cache in-memory com TTL
- [ ] Persistir preferÃªncias em AsyncStorage
- [ ] Criar sistema de invalidaÃ§Ã£o de cache
- [ ] Implementar modo offline read-only bÃ¡sico
- [ ] Otimizar sincronizaÃ§Ã£o com backend
- [ ] Documentar estratÃ©gia de cache

---

## ğŸ“ Subtarefas

### 19.1 - Cache Service
**Estimativa:** M
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/shared/services/storage/cache.service.ts`

**CÃ³digo:**
```typescript
interface CacheEntry<T> {
  data: T;
  timestamp: number;
  ttl: number;
}

class CacheManager {
  private cache = new Map<string, CacheEntry<any>>();

  set<T>(key: string, data: T, ttl: number = 5 * 60 * 1000) {
    this.cache.set(key, { data, timestamp: Date.now(), ttl });
  }

  get<T>(key: string): T | null {
    const entry = this.cache.get(key);
    if (!entry) return null;

    const isExpired = Date.now() - entry.timestamp > entry.ttl;
    if (isExpired) {
      this.cache.delete(key);
      return null;
    }

    return entry.data;
  }

  invalidate(key: string) {
    this.cache.delete(key);
  }

  clear() {
    this.cache.clear();
  }
}

export const cacheManager = new CacheManager();
```

**Checklist:**
- [ ] CacheManager implementado
- [ ] TTL configurÃ¡vel
- [ ] InvalidaÃ§Ã£o por chave
- [ ] Clear all
- [ ] Testes unitÃ¡rios

### 19.2 - Storage Service (AsyncStorage)
**Estimativa:** M
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/shared/services/storage/storage.service.ts`

**CÃ³digo:**
```typescript
import AsyncStorage from '@react-native-async-storage/async-storage';

export async function setItem(key: string, value: any) {
  try {
    const jsonValue = JSON.stringify(value);
    await AsyncStorage.setItem(key, jsonValue);
  } catch (e) {
    console.error('Error saving to AsyncStorage', e);
  }
}

export async function getItem<T>(key: string): Promise<T | null> {
  try {
    const jsonValue = await AsyncStorage.getItem(key);
    return jsonValue != null ? JSON.parse(jsonValue) : null;
  } catch (e) {
    console.error('Error reading from AsyncStorage', e);
    return null;
  }
}

export async function removeItem(key: string) {
  try {
    await AsyncStorage.removeItem(key);
  } catch (e) {
    console.error('Error removing from AsyncStorage', e);
  }
}
```

**Checklist:**
- [ ] setItem, getItem, removeItem
- [ ] SerializaÃ§Ã£o/deserializaÃ§Ã£o JSON
- [ ] Tratamento de erros
- [ ] Testes unitÃ¡rios

### 19.3 - IntegraÃ§Ã£o de Cache nos Services
**Estimativa:** L
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/shared/services/api/transactions.service.ts`
- `src/shared/services/api/dashboard.service.ts`

**CÃ³digo:**
```typescript
export async function getTransactions(params?: TransactionFilters) {
  const cacheKey = `transactions:${JSON.stringify(params)}`;

  // Tentar cache primeiro
  const cached = cacheManager.get(cacheKey);
  if (cached) return cached;

  // Buscar na API
  const response = await apiClient.get('/api/v1/transactions', { params });
  const data = response.data;

  // Salvar no cache (TTL 5 min)
  cacheManager.set(cacheKey, data, 5 * 60 * 1000);

  return data;
}
```

**Checklist:**
- [ ] Cache em transactions.service
- [ ] Cache em dashboard.service
- [ ] Cache em accounts.service
- [ ] Cache em categories.service
- [ ] InvalidaÃ§Ã£o ao criar/editar/deletar

### 19.4 - InvalidaÃ§Ã£o AutomÃ¡tica
**Estimativa:** M
**Tipo:** Desenvolvimento

**Checklist:**
- [ ] Invalidar cache ao criar transaÃ§Ã£o
- [ ] Invalidar cache ao editar transaÃ§Ã£o
- [ ] Invalidar cache ao deletar transaÃ§Ã£o
- [ ] Invalidar cache relacionado (dashboard, reports)

### 19.5 - Offline Mode (Read-Only)
**Estimativa:** M
**Tipo:** Desenvolvimento

**Arquivos:**
- `src/shared/hooks/useNetworkStatus.ts`

**CÃ³digo:**
```typescript
import NetInfo from '@react-native-community/netinfo';

export function useNetworkStatus() {
  const [isOnline, setIsOnline] = useState(true);

  useEffect(() => {
    const unsubscribe = NetInfo.addEventListener(state => {
      setIsOnline(state.isConnected ?? false);
    });

    return () => unsubscribe();
  }, []);

  return { isOnline };
}
```

**Checklist:**
- [ ] Hook useNetworkStatus
- [ ] Banner "Offline" quando sem conexÃ£o
- [ ] Mostrar dados em cache (read-only)
- [ ] Desabilitar criaÃ§Ã£o/ediÃ§Ã£o quando offline

### 19.6 - PersistÃªncia de PreferÃªncias
**Estimativa:** S
**Tipo:** Desenvolvimento

**Checklist:**
- [ ] Tema persistido
- [ ] Idioma persistido
- [ ] NotificaÃ§Ãµes persistidas
- [ ] Onboarding completed persistido

### 19.7 - Cache de Categorias e Contas
**Estimativa:** S
**Tipo:** Desenvolvimento

**Checklist:**
- [ ] Categorias com TTL indefinido (mudam raramente)
- [ ] Contas com TTL indefinido
- [ ] InvalidaÃ§Ã£o manual ao editar

### 19.8 - DocumentaÃ§Ã£o
**Estimativa:** S
**Tipo:** DocumentaÃ§Ã£o

**Arquivos:**
- `docs/CACHE_STRATEGY.md`

**Checklist:**
- [ ] Documentar TTLs por tipo de dado
- [ ] Documentar estratÃ©gia de invalidaÃ§Ã£o
- [ ] Exemplos de uso

### 19.9 - Testes
**Estimativa:** M
**Tipo:** Teste

**Checklist:**
- [ ] Testes do CacheManager
- [ ] Testes de expiraÃ§Ã£o (TTL)
- [ ] Testes de invalidaÃ§Ã£o
- [ ] Cobertura > 80%

---

## ğŸ”— DependÃªncias

**Bloqueia:** Nenhuma
**Bloqueado por:** 8.0
**Paralelo com:** 18.0

---

## âœ… CritÃ©rios de Sucesso

- [ ] Cache in-memory funcionando
- [ ] TTL de 5 minutos para transaÃ§Ãµes
- [ ] InvalidaÃ§Ã£o automÃ¡tica ao mutar dados
- [ ] PreferÃªncias persistindo em AsyncStorage
- [ ] Modo offline read-only bÃ¡sico
- [ ] Banner offline exibindo
- [ ] Cobertura de testes: 80%
- [ ] Code review aprovado

---

## ğŸ“š ReferÃªncias

- [PRD - SeÃ§Ã£o 4.2: IntegraÃ§Ã£o Backend](../prd.md#42-integraÃ§Ã£o-backend)
- [Tech Spec - 1.2: DecisÃµes Arquiteturais](../tech-spec.md#12-decisoes-arquiteturais-principais)
- [AsyncStorage Docs](https://react-native-async-storage.github.io/async-storage/)

---

## ğŸ·ï¸ Tags

`#cache` `#persistence` `#offline` `#performance` `#high-priority`

---

## ğŸ“Œ Notas Importantes

- NÃƒO usar SQLite para dados de negÃ³cio (API Ã© fonte Ãºnica)
- AsyncStorage apenas para preferÃªncias e cache nÃ£o-crÃ­tico
- Tokens JWT devem ir no SecureStore (criptografado)
- TTL padrÃ£o: 5 minutos para dados transacionais
- Categorias/contas: TTL indefinido (invalidaÃ§Ã£o manual)
- Modo offline: read-only apenas (sem sincronizaÃ§Ã£o bidirecional no MVP)
- Cache keys devem incluir parÃ¢metros de filtro
- Limpar cache ao fazer logout

---

**Criado em:** 2025-11-10
**Atualizado em:** 2025-11-10
**Status:** â³ NÃ£o iniciada
