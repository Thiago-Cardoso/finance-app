---
status: pending
parallelizable: false
blocked_by: []
priority: high
---

<task_context>
<domain>backend/testing/models</domain>
<type>testing</type>
<scope>quality_assurance</scope>
<complexity>medium</complexity>
<dependencies>rspec|factory_bot|faker</dependencies>
<unblocks>production_deploy</unblocks>
</task_context>

# Tarefa 5.1: Testes Automatizados de Models

## Visão Geral

Implementar suite completa de testes automatizados (RSpec) para os 6 models do sistema (User, Category, Account, Transaction, Budget, Goal) com cobertura > 90%. Esta tarefa é crítica para garantir qualidade do código e segurança para deploy em produção.

## Contexto

A Tarefa 5.0 implementou todos os models e migrações com sucesso, mas a subtarefa 5.8 (testes) não foi completada. Esta tarefa é um desdobramento necessário para:
- Validar comportamento dos models automaticamente
- Prevenir regressões em mudanças futuras
- Cumprir critério de sucesso: cobertura > 90%
- Habilitar deploy em produção com segurança

## Requisitos

- Criar specs RSpec para todos os 6 models
- Implementar factories completas com FactoryBot
- Testar validações, associações, scopes e métodos
- Atingir > 90% de cobertura de código
- Configurar SimpleCov para relatório de cobertura
- Documentar helpers de teste reutilizáveis

## Subtarefas

- [ ] 5.1.1 Configuração inicial do RSpec e SimpleCov
- [ ] 5.1.2 Factories para todos os models
- [ ] 5.1.3 Specs do User model
- [ ] 5.1.4 Specs do Category model
- [ ] 5.1.5 Specs do Account model
- [ ] 5.1.6 Specs do Transaction model
- [ ] 5.1.7 Specs do Budget model
- [ ] 5.1.8 Specs do Goal model
- [ ] 5.1.9 Verificação de cobertura e relatório

## Detalhes de Implementação

### 5.1.1 Configuração RSpec e SimpleCov

**SimpleCov Configuration:**
```ruby
# spec/spec_helper.rb
require 'simplecov'

SimpleCov.start 'rails' do
  add_filter '/bin/'
  add_filter '/db/'
  add_filter '/spec/'
  add_filter '/config/'

  add_group 'Models', 'app/models'
  add_group 'Controllers', 'app/controllers'
  add_group 'Services', 'app/services'

  minimum_coverage 90
  minimum_coverage_by_file 80
end
```

**RSpec Rails Helper:**
```ruby
# spec/rails_helper.rb
require 'spec_helper'
require File.expand_path('../config/environment', __dir__)
require 'rspec/rails'
require 'factory_bot_rails'
require 'faker'

Dir[Rails.root.join('spec', 'support', '**', '*.rb')].sort.each { |f| require f }

RSpec.configure do |config|
  config.fixture_path = "#{::Rails.root}/spec/fixtures"
  config.use_transactional_fixtures = true
  config.infer_spec_type_from_file_location!
  config.filter_rails_from_backtrace!

  config.include FactoryBot::Syntax::Methods
end
```

### 5.1.2 Factories

**User Factory:**
```ruby
# spec/factories/users.rb
FactoryBot.define do
  factory :user do
    email { Faker::Internet.unique.email }
    password { 'Password123!' }
    password_confirmation { 'Password123!' }
    first_name { Faker::Name.first_name }
    last_name { Faker::Name.last_name }
    confirmed_at { Time.current }

    trait :unconfirmed do
      confirmed_at { nil }
    end

    trait :with_transactions do
      after(:create) do |user|
        create_list(:transaction, 5, user: user)
      end
    end

    trait :with_accounts do
      after(:create) do |user|
        create_list(:account, 3, user: user)
      end
    end

    trait :with_categories do
      after(:create) do |user|
        create_list(:category, 5, user: user)
      end
    end
  end
end
```

**Category Factory:**
```ruby
# spec/factories/categories.rb
FactoryBot.define do
  factory :category do
    name { Faker::Commerce.department }
    color { '#6366f1' }
    category_type { 'expense' }
    is_active { true }

    trait :income do
      category_type { 'income' }
    end

    trait :expense do
      category_type { 'expense' }
    end

    trait :default do
      user { nil }
      is_default { true }
    end

    trait :custom do
      association :user
      is_default { false }
    end

    trait :inactive do
      is_active { false }
    end
  end
end
```

**Account Factory:**
```ruby
# spec/factories/accounts.rb
FactoryBot.define do
  factory :account do
    association :user
    name { Faker::Bank.name }
    account_type { 'checking' }
    initial_balance { 1000.00 }
    current_balance { 1000.00 }
    is_active { true }

    trait :checking do
      account_type { 'checking' }
    end

    trait :savings do
      account_type { 'savings' }
    end

    trait :credit_card do
      account_type { 'credit_card' }
    end

    trait :investment do
      account_type { 'investment' }
    end

    trait :cash do
      account_type { 'cash' }
    end

    trait :inactive do
      is_active { false }
    end
  end
end
```

**Transaction Factory:**
```ruby
# spec/factories/transactions.rb
FactoryBot.define do
  factory :transaction do
    association :user
    association :category
    association :account

    description { Faker::Lorem.sentence(word_count: 3) }
    amount { Faker::Number.decimal(l_digits: 3, r_digits: 2) }
    transaction_type { 'expense' }
    date { Date.current }

    trait :income do
      transaction_type { 'income' }
      association :category, :income
    end

    trait :expense do
      transaction_type { 'expense' }
      association :category, :expense
    end

    trait :transfer do
      transaction_type { 'transfer' }
      association :transfer_account, factory: :account
      category { nil }
    end

    trait :last_month do
      date { 1.month.ago }
    end

    trait :this_month do
      date { Date.current.beginning_of_month }
    end
  end
end
```

**Budget Factory:**
```ruby
# spec/factories/budgets.rb
FactoryBot.define do
  factory :budget do
    association :user
    association :category, category_type: 'expense'

    name { "Budget for #{Faker::Commerce.department}" }
    amount { 500.00 }
    spent { 0.00 }
    period { 'monthly' }
    start_date { Date.current.beginning_of_month }
    end_date { Date.current.end_of_month }
    is_active { true }

    trait :weekly do
      period { 'weekly' }
      start_date { Date.current.beginning_of_week }
      end_date { Date.current.end_of_week }
    end

    trait :monthly do
      period { 'monthly' }
      start_date { Date.current.beginning_of_month }
      end_date { Date.current.end_of_month }
    end

    trait :yearly do
      period { 'yearly' }
      start_date { Date.current.beginning_of_year }
      end_date { Date.current.end_of_year }
    end

    trait :over_budget do
      spent { 600.00 }
    end

    trait :near_limit do
      spent { 450.00 }
    end
  end
end
```

**Goal Factory:**
```ruby
# spec/factories/goals.rb
FactoryBot.define do
  factory :goal do
    association :user

    title { Faker::Lorem.sentence(word_count: 4) }
    description { Faker::Lorem.paragraph }
    target_amount { 10000.00 }
    current_amount { 0.00 }
    target_date { 6.months.from_now }
    is_achieved { false }

    trait :achieved do
      current_amount { 10000.00 }
      is_achieved { true }
    end

    trait :in_progress do
      current_amount { 5000.00 }
      is_achieved { false }
    end

    trait :overdue do
      target_date { 1.month.ago }
      is_achieved { false }
    end

    trait :no_deadline do
      target_date { nil }
    end
  end
end
```

### 5.1.3 User Model Specs

**Test Coverage:**
```ruby
# spec/models/user_spec.rb
require 'rails_helper'

RSpec.describe User, type: :model do
  describe 'validations' do
    subject { build(:user) }

    it { should validate_presence_of(:email) }
    it { should validate_presence_of(:first_name) }
    it { should validate_presence_of(:last_name) }
    it { should validate_uniqueness_of(:email).case_insensitive }
    it { should validate_length_of(:first_name).is_at_most(100) }
    it { should validate_length_of(:last_name).is_at_most(100) }

    it 'validates email format' do
      user = build(:user, email: 'invalid')
      expect(user).not_to be_valid
      expect(user.errors[:email]).to include('is invalid')
    end
  end

  describe 'associations' do
    it { should have_many(:transactions).dependent(:destroy) }
    it { should have_many(:categories).dependent(:destroy) }
    it { should have_many(:accounts).dependent(:destroy) }
    it { should have_many(:budgets).dependent(:destroy) }
    it { should have_many(:goals).dependent(:destroy) }
  end

  describe 'callbacks' do
    describe '#generate_jti' do
      it 'generates JTI before validation on create' do
        user = User.new(
          email: 'test@example.com',
          password: 'password123',
          first_name: 'John',
          last_name: 'Doe'
        )

        expect(user.jti).to be_nil
        user.valid?
        expect(user.jti).to be_present
        expect(user.jti).to match(/\A[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}\z/)
      end

      it 'does not regenerate JTI on update' do
        user = create(:user)
        original_jti = user.jti

        user.update(first_name: 'Jane')
        expect(user.jti).to eq(original_jti)
      end
    end
  end

  describe 'instance methods' do
    describe '#full_name' do
      it 'returns first name and last name combined' do
        user = build(:user, first_name: 'John', last_name: 'Doe')
        expect(user.full_name).to eq('John Doe')
      end
    end

    describe '#current_month_summary' do
      let(:user) { create(:user) }
      let(:category) { create(:category, :expense) }
      let(:account) { create(:account, user: user, current_balance: 5000) }

      before do
        create(:transaction, :income, user: user, account: account, amount: 1000, date: Date.current)
        create(:transaction, :expense, user: user, account: account, category: category, amount: 500, date: Date.current)
        create(:transaction, :expense, user: user, account: account, category: category, amount: 300, date: 2.months.ago)
      end

      it 'returns income, expenses and balance for current month' do
        summary = user.current_month_summary

        expect(summary[:income]).to eq(1000)
        expect(summary[:expenses]).to eq(500)
        expect(summary[:balance]).to eq(5000)
      end
    end
  end
end
```

### 5.1.4-5.1.8 Specs para Outros Models

Seguir estrutura similar:
- **Validations:** Testar todas as validações
- **Associations:** Verificar belongs_to/has_many
- **Scopes:** Testar retorno de cada scope
- **Callbacks:** Validar execução de callbacks
- **Instance Methods:** Testar cada método público
- **Class Methods:** Testar métodos de classe

**Casos de Teste Essenciais:**

**Transaction:**
- Validar update de account balance após create/update/destroy
- Testar transfer entre contas
- Validar category type matching transaction type

**Budget:**
- Testar cálculo de spent_amount
- Validar percentage_used
- Testar is_over_budget? e is_near_limit?

**Goal:**
- Testar percentage_achieved
- Validar suggested_monthly_contribution
- Testar add_contribution com achievement

**Category:**
- Testar available_for_user com default e custom
- Validar color format
- Testar scopes (defaults, custom, active)

**Account:**
- Testar update_balance_from_transaction
- Validar tipos de conta
- Testar monthly_balance_evolution

### 5.1.9 Verificação de Cobertura

**Comando para executar:**
```bash
bundle exec rspec spec/models --format documentation
open coverage/index.html
```

**Targets de Cobertura:**
- Overall: > 90%
- Por arquivo: > 80%
- Branches: > 85%

## Critérios de Sucesso

- [ ] RSpec e SimpleCov configurados corretamente
- [ ] Factories para todos os 6 models implementadas
- [ ] Specs para User model (> 90% coverage)
- [ ] Specs para Category model (> 90% coverage)
- [ ] Specs para Account model (> 90% coverage)
- [ ] Specs para Transaction model (> 90% coverage)
- [ ] Specs para Budget model (> 90% coverage)
- [ ] Specs para Goal model (> 90% coverage)
- [ ] Cobertura geral > 90%
- [ ] Todos os testes passando (green)
- [ ] Documentação de helpers criada

## Estimativa de Tempo

- **Tempo Total**: 4-6 horas
- **Complexidade**: Média (muitos models, mas padrão similar)
- **Prioridade**: ALTA (bloqueia deploy em produção)
- **Risco**: Baixo (testes são isolados)

## Entregáveis

1. Configuração RSpec e SimpleCov em spec/
2. 6 arquivos de factories em spec/factories/
3. 6 arquivos de specs em spec/models/
4. Relatório de cobertura (coverage/)
5. Documentação de setup de testes no README
6. CI/CD configurado para rodar testes (opcional)

## Notas Adicionais

**Por que esta tarefa é crítica:**
- Subtarefa 5.8 da Tarefa 5.0 não foi completada
- Critério de sucesso "cobertura > 90%" não foi atendido
- Deploy em produção não recomendado sem testes
- Previne regressões em mudanças futuras
- Documenta comportamento esperado dos models

**Ferramentas Necessárias:**
- rspec-rails (já instalado)
- factory_bot_rails (já instalado)
- faker (já instalado)
- shoulda-matchers (já instalado)
- simplecov (já instalado)
- database_cleaner (já instalado)

**Referências:**
- [RSpec Rails Documentation](https://rspec.info/documentation/)
- [FactoryBot Guide](https://github.com/thoughtbot/factory_bot)
- [Shoulda Matchers](https://github.com/thoughtbot/shoulda-matchers)